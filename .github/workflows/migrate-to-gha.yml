name: Migración Automatizada a GitHub Actions (con Groq - DEBUG FINAL)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: read

jobs:
  debug-and-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build.outputs.matrix || '[]' }}
    steps:
      - name: Checkout repositorio de migración
        uses: actions/checkout@v4

      - name: Mostrar todo el entorno (depuración máxima)
        run: |
          echo "Directorio actual:"
          pwd
          echo ""
          echo "Archivos en la raíz del repositorio:"
          ls -la
          echo ""
          echo "Archivos JSON en todo el repositorio:"
          find . -type f -name "*json" -o -name "*config*" -o -name "*repos*" 2>/dev/null || echo "No se encontró ningún JSON"
          echo ""
          echo "Rama actual:"
          git branch --show-current
          echo ""
          echo "Último commit:"
          git log -1 --oneline
          echo ""
          echo "Contenido de repos-config.json si existe en raíz:"
          if [ -f repos-config.json ]; then
            echo "✅ ENCONTRADO"
            cat repos-config.json
            echo ""
            echo "Validando JSON con jq:"
            jq . repos-config.json > /dev/null 2>&1 && echo "JSON válido" || echo "JSON inválido (revisa comas/llaves)"
          else
            echo "❌ NO EXISTE repos-config.json en la raíz"
            echo "Posibles nombres alternativos que sí existen:"
            ls -la | grep -i json || echo "Ninguno"
          fi

      - name: Generar matrix (con todos los safeguards)
        id: build
        run: |
          if [ ! -f repos-config.json ]; then
            echo "ERROR: repos-config.json no encontrado. Matrix = []"
            echo "matrix=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "JSON encontrado. Parseando..."
          RAW=$(jq -r '
            .[] 
            | (.branches // [.branch // "master"]) as $b
            | $b[]
            | {
                repo: .repo // "MISSING_REPO",
                branch: .,
                shared_lib_path: (.shared_lib_path // "vars/"),
                jenkins_path: (.jenkins_path // "Jenkinsfile"),
                type: (.type // "jenkins")
              }
            | @json
          ' repos-config.json 2>&1)

          echo "Salida cruda de jq (incluye errores si hay):"
          echo "$RAW"

          MATRIX=$(echo "$RAW" | jq -s -c 'map(select(.repo != "MISSING_REPO"))' 2>&1 || echo "[]")

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          echo "Matrix final:"
          echo "$MATRIX" | jq . || echo "Matrix inválida o vacía"

          if [ "$MATRIX" = "[]" ]; then
            echo "MATRIX VACÍA - Causas probables:"
            echo "1. JSON vacío o sin objetos válidos"
            echo "2. Sin campo 'repo' o 'branch'/'branches'"
            echo "3. Error de sintaxis JSON (coma extra, llave mal cerrada)"
          else
            echo "ÉXITO - Matrix tiene $(echo "$MATRIX" | jq length) entradas"
          fi

  migrate:
    needs: debug-and-matrix
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.debug-and-matrix.outputs.matrix) != '[]' }}
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        config: ${{ fromJson(needs.debug-and-matrix.outputs.matrix) }}
    steps:

      # Aquí puedes poner tus pasos reales (checkout, find-files, script Groq, artifacts)
      - run: echo "Job migración ejecutado - agrega tus pasos aquí"